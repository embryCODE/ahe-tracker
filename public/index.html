<!DOCTYPE html>
<html xmlns:v-on="http://www.w3.org/1999/xhtml" lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Agnostic Healthy Eating Tracker</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
        integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"
        integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

  <link rel="stylesheet" href="css/style.css">

  <!-- Bootstrap & jQuery JS -->
  <script
    src="https://code.jquery.com/jquery-3.2.1.min.js"
    integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
    crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
          integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
          crossorigin="anonymous"></script>

  <!-- Vue -->
  <script src="https://unpkg.com/vue"></script>
  <script src="https://unpkg.com/vue-resource@1.3.1/dist/vue-resource.min.js"></script>

</head>
<body>

<div id="wrapper" class="container">
  <h1>Agnostic Healthy Eating Tracker</h1>
  <p class="main-description">
    Eat each type of “essential” food more often than any type of “recommended” food. Eat each type of “recommended”
    food more often than any type of “acceptable” food. For extra credit, eat each of the ten food types in the
    diet-quality hierarchy more often than any food type of lower rank.
  </p>

  <hr>

  <div id="app" class="center-block">

    <food-list
      v-bind:user="user"
      v-on:change-counter="changeCounter">
    </food-list>

  </div>
</div>

<script type="text/x-template" id="food-list-template">
  <div>
    <ul v-for="category in foodCategories" class="list-unstyled">
      <h4 class="food-category-name">{{category.categoryName}}</h4>
      <li v-for="food in category.foods" class="food-li row">
        <span class="food-name col-xs-7">{{food.foodName}}</span>
        <div class="counter-div col-xs-5">
          <button type="button" class="counter-button" aria-label="Decrease"
                  v-on:click="emitChangeCounter(food._id, -.5)"><span class="glyphicon glyphicon-menu-left"
                                                                   aria-hidden="true"></span></button>
          <span class="counter">{{food.counter}}</span>
          <button type="button" class="counter-button" aria-label="Increase"
                  v-on:click="emitChangeCounter(food._id, .5)"><span class="glyphicon glyphicon-menu-right"
                                                                   aria-hidden="true"></span></button>
        </div>
      </li>
    </ul>
  </div>
</script>

<script>

  var foodListComponent = {
    'food-list': {
      template: '#food-list-template',
      props: [
        'user'
      ],
      computed: {
        foodCategories: function () {
          if (this.user) {
            var categories = []
            var foodsByCategory = []

            // Look at all foods and add found category names to categories array
            this.user.foods.forEach(function (food) {
              if (categories.indexOf(food.foodCategory) === -1) {
                categories.push(food.foodCategory)
              }
            })

            // Look at categories and add objects with correct shape to foodsByCategory
            categories.forEach(function (category) {
              foodsByCategory.push({
                categoryName: category,
                foods: []
              })
            })

            // Add foods to the appropriate category
            this.user.foods.forEach(function (food) {
              foodsByCategory.forEach(function (category) {
                if (category.categoryName === food.foodCategory) {
                  category.foods.push(food)
                }
              })
            })

            // Sort each food array by priorityIndex
            foodsByCategory.forEach(function (category) {
              category.foods.sort(function (a, b) {
                return a.priorityIndex - b.priorityIndex
              })
            })

            return foodsByCategory
          }
        }
      },
      methods: {
        emitChangeCounter: function (foodId, changeAmount) {
          this.$emit('change-counter', foodId, changeAmount)
        }
      }
    }
  }

  var AHE = new Vue({
      el: '#app',
      name: 'AHE Tracker',
      http: {
        root: '/root'
      },
      data: {
        user: null
      },
      components: foodListComponent,
      methods: {
        changeCounter: function (foodId, changeAmount) {
          const self = this
          this.user.foods.forEach(function (food) {
            if (food._id === foodId) {
              const userId = self.user._id

              food.counter += changeAmount

              self.$http.put(`/api/users/${userId}/foods/${foodId}/count/${food.counter}`)
            }
          })
        },
        getUser: function (userId) {
          return this.$http.get('/api/users/' + userId)
            .then(user => {
              return user.data
            }, err => {
              console.log(err)
            })
        }
      },
      created: function () {
        // TODO: Replace this temporary hard-coding of Mason's user id
        this.getUser('591c4e51dee8e88498e7aa03').then(user => {
          this.user = user
        })
      }
    }
  )

</script>

</body>
</html>