<!DOCTYPE html>
<html xmlns:v-on="http://www.w3.org/1999/xhtml" lang="en">
<head>
  <meta charset="UTF-8">
  <title>Agnostic Healthy Eating Tracker</title>

  <link rel="stylesheet" href="css/style.css">

  <script src="https://unpkg.com/vue"></script>

</head>
<body>

<h1>Agnostic Healthy Eating Tracker</h1>
Eat each type of “essential” food more often than any type of “recommended” food. Eat each type of “recommended”
food more often than any type of “acceptable” food. For extra credit, eat each of the ten food types in the
diet-quality hierarchy more often than any food type of lower rank.

<div id="app">

  <food-list
    v-bind:foods="foods"
    v-on:increase-counter="increaseCounter"
    v-on:decrease-counter="decreaseCounter">
  </food-list>

</div>

<script type="text/x-template" id="food-list-template">
  <div>
    <ul v-for="category in foodCategories">
      <h2 class="food-category-name">{{category.categoryName}}</h2>
      <li v-for="food in category.foods">
        <span class="food-name">{{food.foodName}}</span>
        <span class="counter-button" v-on:click="emitDecreaseCounter(food.foodName)"><</span>
        <span class="counter">{{food.counter}}</span>
        <span class="counter-button" v-on:click="emitIncreaseCounter(food.foodName)">></span>
      </li>
    </ul>
  </div>
</script>

<script>

  var foodListComponent = {
    'food-list': {
      props: [
        'foods'
      ],
      template: '#food-list-template',
      computed: {
        foodCategories: function () {
          var categories = []
          var foodsByCategory = []

          // Look at all foods and add found category names to categories array
          this.foods.forEach(function (food) {
            if (categories.indexOf(food.foodCategory) === -1) {
              categories.push(food.foodCategory)
            }
          })

          // Look at categories and add objects with correct shape to foodsByCategory
          categories.forEach(function (category) {
            foodsByCategory.push({
              categoryName: category,
              foods: []
            })
          })

          // Add foods to the appropriate category
          this.foods.forEach(function (food) {
            foodsByCategory.forEach(function (category) {
              if (category.categoryName === food.foodCategory) {
                category.foods.push(food)
              }
            })
          })

          // Sort each food array by priorityIndex
          foodsByCategory.forEach(function (category) {
            category.foods.sort(function (a, b) {
              return a.priorityIndex - b.priorityIndex
            })
          })

          return foodsByCategory
        }
      },
      methods: {
        emitIncreaseCounter: function (foodName) {
          this.$emit('increase-counter', foodName)
        },
        emitDecreaseCounter: function (foodName) {
          this.$emit('decrease-counter', foodName)
        }
      }
    }
  }

  var AHE = new Vue({
    el: '#app',
    name: 'AHE Tracker',
    components: foodListComponent,
    data: {
      foods: []
    },
    methods: {
      increaseCounter: function (foodName) {
        this.foods.forEach(function (food) {
          if (food.foodName === foodName) {
            food.counter += .5
            fetch('/api/v1/foods/' + food._id, {
              method: 'post',
              headers: {
                'Accept': 'application/json, application/xml, text/plain, text/html, *.*',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(food)
            })
          }
        })
      },
      decreaseCounter: function (foodName) {
        this.foods.forEach(function (food) {
          if (food.foodName === foodName) {
            food.counter -= .5
            fetch('/api/v1/foods/' + food._id, {
              method: 'post',
              headers: {
                'Accept': 'application/json, application/xml, text/plain, text/html, *.*',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(food)
            })
          }
        })
      }
    },
    created: function () {
      fetch('/api/v1/foods').then(function (res) {
        return res.json()
      })
        .then(json => {
          this.foods = json
        })
    }
  })

</script>

</body>
</html>