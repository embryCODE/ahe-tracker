<!DOCTYPE html>
<html xmlns:v-on="http://www.w3.org/1999/xhtml" lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Agnostic Healthy Eating Tracker</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
        integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"
        integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

  <link rel="stylesheet" href="css/style.css">

  <!-- Bootstrap & jQuery JS -->
  <script
    src="https://code.jquery.com/jquery-3.2.1.min.js"
    integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
    crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
          integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
          crossorigin="anonymous"></script>

  <script src="https://unpkg.com/vue"></script>

</head>
<body>

<div id="wrapper" class="container">
  <h1>Agnostic Healthy Eating Tracker</h1>
  <p>
    Eat each type of “essential” food more often than any type of “recommended” food. Eat each type of “recommended”
    food more often than any type of “acceptable” food. For extra credit, eat each of the ten food types in the
    diet-quality hierarchy more often than any food type of lower rank.
  </p>

  <hr>

  <div id="app">

    <food-list
      v-bind:foods="foods"
      v-on:increase-counter="increaseCounter"
      v-on:decrease-counter="decreaseCounter">
    </food-list>

  </div>
</div>

<script type="text/x-template" id="food-list-template">
  <div>
    <ul v-for="category in foodCategories" class="list-unstyled">
      <h4 class="food-category-name">{{category.categoryName}}</h4>
      <li v-for="food in category.foods" class="food-li row">
        <span class="food-name col-xs-7">{{food.foodName}}</span>
        <div class="counter-div col-xs-4 col-xs-offset-1">
          <button type="button" class="counter-button" aria-label="Decrease"
                  v-on:click="emitDecreaseCounter(food.foodName)"><span class="glyphicon glyphicon-menu-left"
                                                                        aria-hidden="true"></span></button>
          <span class="counter">{{food.counter}}</span>
          <button type="button" class="counter-button" aria-label="Increase"
                  v-on:click="emitIncreaseCounter(food.foodName)"><span class="glyphicon glyphicon-menu-right"
                                                                        aria-hidden="true"></span></button>
        </div>
      </li>
    </ul>
  </div>
</script>

<script>

  var foodListComponent = {
    'food-list': {
      props: [
        'foods'
      ],
      template: '#food-list-template',
      computed: {
        foodCategories: function () {
          var categories = []
          var foodsByCategory = []

          // Look at all foods and add found category names to categories array
          this.foods.forEach(function (food) {
            if (categories.indexOf(food.foodCategory) === -1) {
              categories.push(food.foodCategory)
            }
          })

          // Look at categories and add objects with correct shape to foodsByCategory
          categories.forEach(function (category) {
            foodsByCategory.push({
              categoryName: category,
              foods: []
            })
          })

          // Add foods to the appropriate category
          this.foods.forEach(function (food) {
            foodsByCategory.forEach(function (category) {
              if (category.categoryName === food.foodCategory) {
                category.foods.push(food)
              }
            })
          })

          // Sort each food array by priorityIndex
          foodsByCategory.forEach(function (category) {
            category.foods.sort(function (a, b) {
              return a.priorityIndex - b.priorityIndex
            })
          })

          return foodsByCategory
        }
      },
      methods: {
        emitIncreaseCounter: function (foodName) {
          this.$emit('increase-counter', foodName)
        },
        emitDecreaseCounter: function (foodName) {
          this.$emit('decrease-counter', foodName)
        }
      }
    }
  }

  var AHE = new Vue({
    el: '#app',
    name: 'AHE Tracker',
    components: foodListComponent,
    data: {
      foods: []
    },
    methods: {
      increaseCounter: function (foodName) {
        this.foods.forEach(function (food) {
          if (food.foodName === foodName) {
            food.counter += .5
            fetch('/api/v1/food/' + food._id, {
              method: 'post',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(food)
            })
          }
        })
      },
      decreaseCounter: function (foodName) {
        this.foods.forEach(function (food) {
          if (food.foodName === foodName) {
            food.counter -= .5
            fetch('/api/v1/food/' + food._id, {
              method: 'post',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(food)
            })
          }
        })
      }
    },
    created: function () {
      fetch('/api/v1/food').then(function (res) {
        return res.json()
      })
        .then(json => {
          this.foods = json
        })
    }
  })

</script>

</body>
</html>